# SDS Gateway CLI 实现总结

## 完成时间
2026-01-04 15:45

## 功能概述

实现了 SDS CLI 和 Controller 中的网关管理功能，可以自动生成 drbd-reactor 的 TOML 配置文件，用于 iSCSI、NFS 和 NVMe-oF 网关的配置。

## 实现内容

### 1. Proto 定义更新

**文件**: `api/proto/v1/sds.proto`

更新了网关相关的请求和响应消息：

```protobuf
message CreateNFSGatewayRequest {
  string resource = 1;           // DRBD resource name
  string service_ip = 2;         // Service IP (e.g., "192.168.1.200/24")
  string export_path = 3;        // Base export path (e.g., "/data")
  repeated string allowed_ips = 4; // Allowed client IPs
  string fs_type = 5;            // Filesystem type (ext4, xfs)
  map<string, string> options = 6; // Additional options
}

message CreateISCSIGatewayRequest {
  string resource = 1;           // DRBD resource name
  string service_ip = 2;         // Service IP (e.g., "192.168.1.100/24")
  string iqn = 3;                // iSCSI Qualified Name
  repeated string allowed_initiators = 4; // Allowed initiator IQNs
  string username = 5;           // CHAP username
  string password = 6;           // CHAP password
  string implementation = 7;     // iSCSI implementation (lio, tgt, iet)
  map<string, string> options = 8; // Additional options
}

message CreateNVMeGatewayRequest {
  string resource = 1;           // DRBD resource name
  string service_ip = 2;         // Service IP (e.g., "192.168.1.150/24")
  string nqn = 3;                // NVMe Qualified Name
  string transport_type = 4;     // Transport type (tcp, rdma)
  map<string, string> options = 5; // Additional options
}
```

### 2. Controller 实现

**文件**: `pkg/controller/gateway.go`

实现了 `GatewayManager`，负责：
- 解析请求参数
- 生成 drbd-reactor TOML 配置
- 写入配置文件到 `/etc/drbd-reactor.d/`
- 管理网关生命周期

关键方法：
```go
func (gm *GatewayManager) CreateISCSIGateway(ctx context.Context, req *v1.CreateISCSIGatewayRequest) (*v1.CreateISCSIGatewayResponse, error)
func (gm *GatewayManager) CreateNFSGateway(ctx context.Context, req *v1.CreateNFSGatewayRequest) (*v1.CreateNFSGatewayResponse, error)
func (gm *GatewayManager) CreateNVMeGateway(ctx context.Context, req *v1.CreateNVMeGatewayRequest) (*v1.CreateNVMeGatewayResponse, error)
```

### 3. CLI 命令实现

**文件**: `cmd/cli/gateway.go`

实现了完整的网关管理 CLI 命令：

```
sds gateway
├── iscsi
│   ├── create
│   └── list
├── nfs
│   ├── create
│   └── list
├── nvme
│   ├── create
│   └── list
└── list
```

### 4. 生成的 TOML 配置示例

#### iSCSI 网关配置

```toml
# SDS iSCSI Gateway Configuration
# Generated by SDS Controller
# Resource: r0
# IQN: iqn.2024-01.com.example:storage.r0
# Service IP: 192.168.1.100

[[promoter]]

  [promoter.metadata]
    linstor-gateway-schema-version = 1

  [promoter.resources]

    [promoter.resources.r0]
      on-drbd-demote-failure = "reboot-immediate"
      runner = "systemd"
      start = [
        "ocf:heartbeat:Filesystem fs_cluster_private device=/dev/drbd0 directory=/var/lib/sds/r0-cluster-private fstype=ext4 run_fsck=no",
        "ocf:heartbeat:portblock pblock0 ip=192.168.1.100 portno=3260 action=block protocol=tcp",
        "ocf:heartbeat:IPaddr2 service_ip0 ip=192.168.1.100 cidr_netmask=24",
        "ocf:heartbeat:iSCSITarget target iqn=iqn.2024-01.com.example:storage.r0 portals=192.168.1.100:3260 incoming_username= incoming_password= allowed_initiators= implementation=lio",
        "ocf:heartbeat:iSCSILogicalUnit lu1 target_iqn=iqn.2024-01.com.example:storage.r0 lun=1 path=/dev/drbd1 product_id=a1b2c3d4 scsi_sn=a1b2c3d4",
        "ocf:heartbeat:iSCSILogicalUnit lu2 target_iqn=iqn.2024-01.com.example:storage.r0 lun=2 path=/dev/drbd2 product_id=e5f6g7h8 scsi_sn=e5f6g7h8",
        "ocf:heartbeat:portblock portunblock0 ip=192.168.1.100 portno=3260 action=unblock protocol=tcp tickle_dir=/var/lib/sds/r0-cluster-private",
      ]
      stop-services-on-exit = true
      target-as = "Requires"
```

配置文件路径：`/etc/drbd-reactor.d/sds-iscsi-<resource>.toml`

#### NFS 网关配置

```toml
# SDS NFS Gateway Configuration
# Generated by SDS Controller
# Resource: nfs-data
# Service IP: 192.168.1.200
# Export Path: /data

[[promoter]]

  [promoter.metadata]
    linstor-gateway-schema-version = 1

  [promoter.resources]

    [promoter.resources.nfs-data]
      on-drbd-demote-failure = "reboot-immediate"
      runner = "systemd"
      start = [
        "ocf:heartbeat:portblock portblock ip=192.168.1.200 portno=2049 action=block protocol=tcp",
        "ocf:heartbeat:Filesystem fs_cluster_private device=/dev/drbd0 directory=/var/lib/sds/nfs-data-cluster-private fstype=ext4 run_fsck=no",
        "ocf:heartbeat:Filesystem fs_1 device=/dev/drbd1 directory=/srv/gateway-exports/nfs-data/data fstype=ext4 run_fsck=no",
        "ocf:heartbeat:IPaddr2 service_ip ip=192.168.1.200 cidr_netmask=24",
        "ocf:heartbeat:nfsserver nfsserver nfs_ip=192.168.1.200 nfs_shared_infodir=/var/lib/sds/nfs-data-cluster-private/nfs nfs_server_scope=192.168.1.200",
        "ocf:heartbeat:exportfs export_1_0 directory=/srv/gateway-exports/nfs-data/data fsid=12345678-1234-1234-1234-123456789abc clientspec=0.0.0.0/0.0.0.0 options=rw,all_squash,anonuid=0,anongid=0",
        "ocf:heartbeat:portblock portunblock ip=192.168.1.200 portno=2049 action=unblock protocol=tcp tickle_dir=/var/lib/sds/nfs-data-cluster-private",
      ]
      stop-services-on-exit = true
      target-as = "BindsTo"
```

配置文件路径：`/etc/drbd-reactor.d/sds-nfs-<resource>.toml`

#### NVMe-oF 网关配置

```toml
# SDS NVMe-oF Gateway Configuration
# Generated by SDS Controller
# Resource: database
# NQN: nqn.2024-01.com.example:subsystem.database
# Service IP: 192.168.1.150

[[promoter]]

  [promoter.metadata]
    linstor-gateway-schema-version = 1

  [promoter.resources]

    [promoter.resources.subsystem.database]
      on-drbd-demote-failure = "reboot-immediate"
      runner = "systemd"
      start = [
        "ocf:heartbeat:portblock portblock ip=192.168.1.150 portno=4420 action=block protocol=tcp",
        "ocf:heartbeat:Filesystem fs_cluster_private device=/dev/drbd0 directory=/var/lib/sds/nvme-cluster-private fstype=ext4 run_fsck=no",
        "ocf:heartbeat:IPaddr2 service_ip ip=192.168.1.150 cidr_netmask=24",
        "ocf:heartbeat:nvmet-subsystem subsys nqn=nqn.2024-01.com.example:subsystem.database serial=a1b2c3d4e5f6g7h8",
        "ocf:heartbeat:nvmet-namespace ns_1 nqn=nqn.2024-01.com.example:subsystem.database namespace_id=1 backing_path=/dev/drbd1 uuid=11111111-2222-3333-4444-555555555555 nguid=11111111-2222-3333-4444-555555555555",
        "ocf:heartbeat:nvmet-namespace ns_2 nqn=nqn.2024-01.com.example:subsystem.database namespace_id=2 backing_path=/dev/drbd2 uuid=66666666-7777-8888-9999-aaaaaaaaaaaa nguid=66666666-7777-8888-9999-aaaaaaaaaaaa",
        "ocf:heartbeat:nvmet-port port nqns=nqn.2024-01.com.example:subsystem.database addr=192.168.1.150 type=tcp",
        "ocf:heartbeat:portblock portunblock ip=192.168.1.150 portno=4420 action=unblock protocol=tcp tickle_dir=/var/lib/sds/nvme-cluster-private",
      ]
      stop-services-on-exit = true
      target-as = "Requires"
```

配置文件路径：`/etc/drbd-reactor.d/sds-nvmeof-<resource>.toml`

## CLI 使用示例

### 创建 iSCSI 网关

```bash
sds gateway iscsi create \
  --resource r0 \
  --iqn iqn.2024-01.com.example:storage.r0 \
  --service-ip 192.168.1.100/24 \
  --implementation lio \
  --username admin \
  --password secretpass
```

### 创建 NFS 网关

```bash
sds gateway nfs create \
  --resource nfs-data \
  --service-ip 192.168.1.200/24 \
  --export-path /data \
  --fs-type ext4 \
  --allowed-ips 192.168.1.0/24
```

### 创建 NVMe-oF 网关

```bash
sds gateway nvme create \
  --resource database \
  --nqn nqn.2024-01.com.example:subsystem.database \
  --service-ip 192.168.1.150/24 \
  --transport tcp
```

### 列出网关

```bash
# 列出所有网关
sds gateway list

# 列出 iSCSI 网关
sds gateway iscsi list

# 列出 NFS 网关
sds gateway nfs list

# 列出 NVMe-oF 网关
sds gateway nvme list
```

## 工作流程

1. **用户调用 CLI 命令**
   ```bash
   sds gateway iscsi create --resource r0 --iqn iqn.2024-01.com.example:storage.r0 --service-ip 192.168.1.100/24
   ```

2. **CLI 构建 gRPC 请求**
   - 创建 `CreateISCSIGatewayRequest` 消息
   - 包含 resource、iqn、service_ip 等参数

3. **Controller 接收请求**
   - `GatewayManager.CreateISCSIGateway()` 处理请求
   - 解析 service IP 和参数

4. **生成 TOML 配置**
   - 使用 Go template 生成配置内容
   - 包含所有必需的 OCF resource agent 配置

5. **写入配置文件**
   - 路径：`/etc/drbd-reactor.d/sds-iscsi-r0.toml`
   - 权限：0644

6. **重新加载 drbd-reactor**
   - 用户需要手动执行：`sudo systemctl reload drbd-reactor`
   - 或者使用自动重载：`sudo systemctl enable --now drbd-reactor-reload.path`

7. **验证配置生效**
   ```bash
   sudo journalctl -u drbd-reactor -f
   sudo drbd-reactor status
   ```

## 配置文件命名规范

- **iSCSI**: `sds-iscsi-<resource>.toml`
- **NFS**: `sds-nfs-<resource>.toml`
- **NVMe-oF**: `sds-nvmeof-<resource>.toml`

## OCF Resource Agent 使用的资源代理

### 通用代理
- `ocf:heartbeat:IPaddr2` - 虚拟 IP 地址
- `ocf:heartbeat:portblock` - 端口阻止/解除
- `ocf:heartbeat:Filesystem` - 文件系统挂载

### iSCSI 专用代理
- `ocf:heartbeat:iSCSITarget` - iSCSI Target 配置
- `ocf:heartbeat:iSCSILogicalUnit` - LUN 导出

### NFS 专用代理
- `ocf:heartbeat:nfsserver` - NFS 服务器
- `ocf:heartbeat:exportfs` - NFS 导出

### NVMe-oF 专用代理
- `ocf:heartbeat:nvmet-subsystem` - NVMe 子系统
- `ocf:heartbeat:nvmet-namespace` - NVMe 命名空间
- `ocf:heartbeat:nvmet-port` - NVMe 端口

## 默认值

| 参数 | 默认值 |
|------|--------|
| iSCSI implementation | lio |
| NVMe transport type | tcp |
| Filesystem type | ext4 |
| Cluster private mount path | /var/lib/sds/<resource>-cluster-private |
| NFS export base path | /srv/gateway-exports |
| Config directory | /etc/drbd-reactor.d |

## 端口使用

| 网关类型 | 默认端口 |
|----------|----------|
| iSCSI | 3260 |
| NFS | 2049 |
| NVMe-oF | 4420 |

## 参考文档

- [DRBD-Reactor Gateway 配置示例](../examples/drbd-reactor/README.md)
- [linstor-gateway 源代码](../../linstor-gateway/)
- [OCF Resource Agent 规范](https://github.com/ClusterLabs/resource-agents)

## 下一步

- [ ] 实现网关删除功能（删除配置文件）
- [ ] 实现网关状态查询
- [ ] 自动重新加载 drbd-reactor
- [ ] 添加网关配置验证
- [ ] 支持多 Service IP 配置
- [ ] 支持动态添加/删除卷

## 测试状态

✅ CLI 命令编译成功
✅ Proto 定义更新完成
✅ Controller 实现完成
✅ CLI 命令测试通过
✅ 在 orange1, orange2, orange3 三个节点上部署测试通过
✅ drbd-reactor 配置解析验证通过

---

**实现时间**: 2026-01-05
**版本**: 1.1
**维护者**: SDS Project Team

## 更新日志

### 2026-01-05 - v1.1
- 修复 TOML 配置结构，使用正确的 drbd-reactor 格式
- 在所有三个节点上验证通过
- 所有三种网关类型（iSCSI, NFS, NVMe-oF）测试通过
